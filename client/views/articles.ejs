<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh sách bài báo - <%= keyword %></title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">
  <!-- Sử dụng navigation chung -->
  <%- include('partials/navigation') %>

  <div class="container mx-auto p-4">
    <div class="mb-6 flex justify-between items-center">
      <h1 class="text-3xl font-bold">Bài báo: <%= keyword %></h1>
      <a href="/" class="text-blue-500 hover:underline">← Quay lại danh sách từ khóa</a>
    </div>

    <!-- Error Message -->
    <% if (typeof error !== 'undefined' && error) { %>
      <div class="bg-red-100 text-red-700 p-4 rounded mb-4">
        <%= error %>
      </div>
    <% } %>

    <!-- Top controls -->
    <div class="bg-white p-4 rounded shadow-md mb-6">
      <!-- Keyword Selector Form -->
      <div class="flex flex-wrap items-center justify-between">
        <div class="mb-2 md:mb-0">
          <form action="/articles" method="GET" class="flex items-center">
            <label for="keywordSelect" class="mr-2 font-medium">Chọn từ khóa:</label>
            <select id="keywordSelect" name="keywordId" class="border p-2 rounded" onchange="this.form.submit()">
              <% keywords.forEach(k => { %>
                <option value="<%= k.id %>" <%= k.id === keywordId ? 'selected' : '' %>><%= k.keyword %></option>
              <% }) %>
            </select>
          </form>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex space-x-2">
          <form action="/start-crawl" method="POST">
            <input type="hidden" name="keywordId" value="<%= keywordId %>">
            <button type="submit" class="bg-green-500 text-white p-2 rounded hover:bg-green-600">
              <span class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                </svg>
                Cập nhật bài báo mới
              </span>
            </button>
          </form>
          <form action="/articles" method="GET">
            <input type="hidden" name="keywordId" value="<%= keywordId %>">
            <button type="submit" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
              <span class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                </svg>
                Làm mới
              </span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Filter Controls -->
    <div class="bg-white p-4 rounded shadow-md mb-6">
      <div class="flex flex-wrap items-center">
        <div class="mr-4 mb-2 md:mb-0">
          <label for="sourceFilter" class="mr-2 font-medium">Lọc theo nguồn:</label>
          <select id="sourceFilter" class="border p-2 rounded" onchange="filterArticles()">
            <option value="">Tất cả</option>
            <!-- Sources will be added dynamically with JavaScript -->
          </select>
        </div>
        
        <div class="mr-4 mb-2 md:mb-0">
          <label for="dateFilter" class="mr-2 font-medium">Lọc theo ngày:</label>
          <select id="dateFilter" class="border p-2 rounded" onchange="filterArticles()">
            <option value="">Tất cả</option>
            <option value="today">Hôm nay</option>
            <option value="yesterday">Hôm qua</option>
            <option value="week">3 ngày qua</option>
          </select>
        </div>
        
        <div class="mb-2 md:mb-0">
          <label for="searchInput" class="mr-2 font-medium">Tìm kiếm:</label>
          <input type="text" id="searchInput" placeholder="Tìm trong tiêu đề..." class="border p-2 rounded w-48" oninput="filterArticles()">
        </div>
      </div>
    </div>

    <!-- Articles Stats -->
    <div class="bg-white p-4 rounded shadow-md mb-6">
      <div class="flex flex-wrap">
        <!-- <div class="w-full md:w-1/3 px-2 mb-4 md:mb-0">
          <div class="bg-blue-50 p-4 rounded border border-blue-200">
            <h3 class="text-lg font-semibold mb-1">Tổng số bài báo</h3>
            <p class="text-3xl font-bold text-blue-600" id="totalArticles"><%= articles.length %></p>
          </div>
        </div> -->
        <div class="w-full md:w-1/2 px-2 mb-4 md:mb-0">
          <div class="bg-green-50 p-4 rounded border border-green-200">
            <h3 class="text-lg font-semibold mb-1">Bài báo hôm nay</h3>
            <p class="text-3xl font-bold text-green-600" id="todayArticles">0</p>
          </div>
        </div>
        <div class="w-full md:w-1/2 px-2">
          <div class="bg-purple-50 p-4 rounded border border-purple-200">
            <h3 class="text-lg font-semibold mb-1">Nguồn khác nhau</h3>
            <p class="text-3xl font-bold text-purple-600" id="uniqueSources">0</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Articles List -->
    <div class="bg-white p-6 rounded shadow-md">
      <h2 class="text-xl font-semibold mb-4">Bài báo <%= keyword ? `cho từ khóa "${keyword}"` : '' %></h2>
      <% if (articles.length === 0) { %>
        <p class="text-gray-500">Chưa có bài báo nào. Hãy nhấn "Cập nhật bài báo mới" để tìm kiếm tin tức.</p>
      <% } else { %>
        <div class="article-list space-y-6">
          <% articles.forEach(article => { %>
            <div class="article-item p-4 bg-gray-50 rounded-lg shadow-sm hover:shadow-md transition-shadow" 
                 data-source="<%= article.source %>" 
                 data-date="<%= article.crawled_at %>">
              <div class="flex flex-wrap md:flex-nowrap">
                <div class="w-full md:w-auto md:flex-shrink-0">
                  <div class="bg-gray-200 p-2 mb-3 md:mb-0 md:mr-4 rounded text-center">
                    <span class="text-xs uppercase font-semibold text-gray-700"><%= article.source %></span>
                    <p class="text-xs text-gray-600">
                      <% 
                        let date = new Date(article.crawled_at);
                        let formattedDate = date.toLocaleDateString('vi-VN');
                      %>
                      <%= formattedDate %>
                    </p>
                  </div>
                </div>
                <div class="w-full">
                  <h3 class="text-lg font-semibold">
                    <a href="<%= article.link %>" target="_blank" class="text-blue-600 hover:underline"><%= article.title %></a>
                  </h3>
                  
                  <% if (article.description) { %>
                    <p class="text-gray-600 my-2 line-clamp-2"><%= article.description %></p>
                  <% } %>
                  
                  <div class="mt-3">
                    <% if (article.summary && article.summary !== 'None') { %>
                      <div class="bg-blue-50 p-3 rounded border-l-4 border-blue-300">
                        <h4 class="text-sm font-semibold text-blue-700 mb-1">Tóm tắt</h4>
                        <p class="text-gray-700 text-sm"><%= article.summary %></p>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>
  </div>

  <footer class="bg-white p-4 mt-8 border-t">
    <div class="container mx-auto text-center text-gray-600">
      <p>&copy; Crawler builded by Nam Anh</p>
    </div>
  </footer>

  <script>
    // Utility function to format dates
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    // Extract unique sources for filter dropdown
    function populateSourceFilter() {
      const sources = new Set();
      document.querySelectorAll('.article-item').forEach(item => {
        sources.add(item.dataset.source);
      });
      
      const sourceFilter = document.getElementById('sourceFilter');
      sources.forEach(source => {
        const option = document.createElement('option');
        option.value = source;
        option.textContent = source;
        sourceFilter.appendChild(option);
      });
    }

    // Calculate statistics
    function calculateStats() {
      // Count unique sources
      const sources = new Set();
      document.querySelectorAll('.article-item').forEach(item => {
        sources.add(item.dataset.source);
      });
      document.getElementById('uniqueSources').textContent = sources.size;
      
      // Count today's articles
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      let todayCount = 0;
      document.querySelectorAll('.article-item').forEach(item => {
        const itemDate = new Date(item.dataset.date);
        if (itemDate >= today) {
          todayCount++;
        }
      });
      document.getElementById('todayArticles').textContent = todayCount;
    }

    // Filter articles based on selected criteria
    function filterArticles() {
      const sourceFilter = document.getElementById('sourceFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      const articles = document.querySelectorAll('.article-item');
      
      let visibleCount = 0;
      
      articles.forEach(article => {
        const source = article.dataset.source;
        const dateValue = new Date(article.dataset.date);
        const title = article.querySelector('h3 a').textContent.toLowerCase();
        
        let sourceMatch = true;
        let dateMatch = true;
        let searchMatch = true;
        
        // Source filter
        if (sourceFilter && source !== sourceFilter) {
          sourceMatch = false;
        }
        
        // Date filter
        if (dateFilter) {
          const now = new Date();
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          
          if (dateFilter === 'today') {
            dateMatch = dateValue >= today;
          } else if (dateFilter === 'yesterday') {
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            dateMatch = dateValue >= yesterday && dateValue < today;
          } else if (dateFilter === 'week') {
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            dateMatch = dateValue >= weekAgo;
          }
        }
        
        // Search filter
        if (searchTerm && !title.includes(searchTerm)) {
          searchMatch = false;
        }
        
        // Show/hide based on filters
        if (sourceMatch && dateMatch && searchMatch) {
          article.style.display = 'block';
          visibleCount++;
        } else {
          article.style.display = 'none';
        }
      });
      
      // Update total count
      document.getElementById('totalArticles').textContent = visibleCount;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      populateSourceFilter();
      calculateStats();
      
      // Add line-clamp utility to tailwind (not included in v2)
      document.querySelectorAll('.line-clamp-2').forEach(el => {
        el.style.overflow = 'hidden';
        el.style.display = '-webkit-box';
        el.style.webkitBoxOrient = 'vertical';
        el.style.webkitLineClamp = '2';
      });
    });
  </script>
</body>
</html>